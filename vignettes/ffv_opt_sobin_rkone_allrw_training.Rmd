---
title: Wage and Employment Comparison Binary Allocation Lalonde Training Example
description: |
  Welfare, Resource Equivalent Variation (REV), comparisons between wage and employment allocation results.
  Wage and Employment allocation space parameters comparison.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Wage and Employment Comparison Binary Allocation Lalonde Training Example}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
urlcolor: blue
---

Test binary allocation queue with Lalonde training dataset. There are 722 observations, 297 in the treatment group, 425 in the control group.

Already completed optimal ranking analysis and regressions for [wage](https://fanwangecon.github.io/PrjOptiAlloc/articles/ffv_opt_sobin_rkone_allfc_training_wage.html) and [employment](https://fanwangecon.github.io/PrjOptiAlloc/articles/ffv_opt_sobin_rkone_allfc_training_logit.html). Here, I combine the results together and generate some joint graphs analyzing:

1. The relationship between expected probability of employment and wage ($A_i$) without training, and the expected return to training for employment and wage ($\alpha_i$).
2. For each individual, does their optimal allocation ranking change under the Rawlsian to Utilitarian planner? For wage vs employment based rankings
3. Who are those ranked in top 10 to receive? Along the spectrum
4. Resource Equivalent Variation along the spectrum


## Load Dependencies

```{r GlobalOptions, echo = T, results = 'hide', message=F, warning=F}
rm(list = ls(all.names = TRUE))
options(knitr.duplicate.label = 'allow')
```
```{r loadlib, echo = T, results = 'hide', message=F, warning=F}
library(dplyr)
library(tidyr)
library(tibble)
library(purrr)
library(stringr)
library(broom)
library(haven)
library(ggplot2)
library(forcats)

library(REconTools)
library(PrjOptiAlloc)

library(knitr)
library(kableExtra)

bl_save_img = FALSE
```

## Merge the Wage and Employmennt Rsults

Generate four categories by initial height and mother's education levels combinations.

```{r}
spt_img_save <- '../_img/'
spt_img_save_draft <- 'C:/Users/fan/Documents/Dropbox (UH-ECON)/repos/HgtOptiAlloDraft/_img/'
```

```{r Load Packages and Process Data}
# Load Data
data(df_opt_lalonde_training_wage)
data(df_opt_lalonde_training_employ)
data(df_opt_lalonde_training_empage)

# dfj, dataframe joint
dfj <- df_opt_lalonde_training_employ %>% 
  left_join(df_opt_lalonde_training_wage, by = 'id') %>% 
  left_join(df_opt_lalonde_training_empage, by = 'id')

# drop the .y variables, clean the .x out
dfj <- dfj %>% select(-contains(".y"), -contains(".x")) 
# %>%
#           rename_at(vars(ends_with(".x")), funs(str_replace(., ".x", "")))

# order and organize variables
dfj <- dfj %>% select(id,
                      starts_with("A_"), starts_with("alpha_"), starts_with("beta_"),
                      contains("rank"), contains("rho"),
                      everything())

# treatment column to numeric
dfj$trt <- as.numeric(dfj$trt) - 1

# Summarize
str(dfj)
summary(dfj)
```

## Compute REV

Compute Resource Equivalent Variations. Assume here that i use here the same ar_rho vector as used in [emloyment](C:\Users\fan\PrjOptiAlloc\vignettes\ffv_opt_sobin_rkone_allfc_training_logit.Rmd) and [wage](C:\Users\fan\PrjOptiAlloc\vignettes\ffv_opt_sobin_rkone_allrw_training_wage.Rmd) regressions.

Note that for each rho, the optimal ranking is different, and there are different optimal rankings for wage and employment outcomes.

```{r compute rev}
ar_rho = c(-100, -0.001,  0.95)
ar_rho <- 1 - (10^(c(seq(-2,2, length.out=30))))
ar_rho <- unique(ar_rho)

ar_bin_observed <- dfj %>% pull(trt)
ar_A_wage <- dfj %>% pull(A_i_wage)
ar_A_employ <- dfj %>% pull(A_i_employ)
ar_A_empage <- dfj %>% pull(A_i_empage)

ar_alpha_wage <- dfj %>% pull(alpha_i_wage)
ar_alpha_employ <- dfj %>% pull(alpha_i_employ)
ar_alpha_empage <- dfj %>% pull(alpha_i_empage)

ar_beta_wage <- dfj %>% pull(beta_i_wage)
ar_beta_employ <- dfj %>% pull(beta_i_employ)
ar_beta_empage <- dfj %>% pull(beta_i_empage)

ar_rev_wage <- rep(0, length(ar_rho))
ar_rev_employ <- rep(0, length(ar_rho))
ar_rev_empage <- rep(0, length(ar_rho))

for (it_rho_ctr in seq(1, length(ar_rho))) {

  fl_rho <- ar_rho[it_rho_ctr]

  svr_rho_employ  <- paste0('rho_c', it_rho_ctr, '_rk_employ')
  svr_rho_wage <- paste0('rho_c', it_rho_ctr, '_rk_wage')
  svr_rho_empage <- paste0('rho_c', it_rho_ctr, '_rk_empage')

  ar_queue_optimal_wage <- dfj %>% pull(svr_rho_wage)
  ar_queue_optimal_employ <- dfj %>% pull(svr_rho_employ)
  ar_queue_optimal_empage <- dfj %>% pull(svr_rho_empage)

  ar_rev_wage[it_rho_ctr] <- ffp_opt_sobin_rev(ar_queue_optimal_wage, ar_bin_observed,
                                               ar_A_wage, ar_alpha_wage, ar_beta_wage,
                                               fl_rho)

  ar_rev_employ[it_rho_ctr] <- ffp_opt_sobin_rev(ar_queue_optimal_employ, ar_bin_observed,
                                                 ar_A_employ, ar_alpha_employ, ar_beta_employ,
                                                 fl_rho)

  ar_rev_empage[it_rho_ctr] <- ffp_opt_sobin_rev(ar_queue_optimal_empage, ar_bin_observed,
                                                 ar_A_empage, ar_alpha_empage, ar_beta_empage,
                                                 fl_rho)
  
}
print(ar_rev_wage)
print(ar_rev_employ)
print(ar_rev_empage)

# combine results
mt_combine <- cbind(ar_rho, ar_rev_wage*100, ar_rev_employ*100, ar_rev_empage*100)
colnames(mt_combine) <- c('rho', 'rev_expected_wage', 'rev_employment_prob', 'rev_employage_prob')
tb_rev_wage_employ <- as_tibble(mt_combine) %>% rowid_to_column(var = "eval")
# Transform x-scale to 1-rho
tb_rev_wage_employ <- tb_rev_wage_employ %>% mutate(one_minus_rho = 1 - rho)

# Reshape to long
tb_rev_wage_employ_long <- tb_rev_wage_employ %>%
  pivot_longer(
    cols = starts_with('rev'),
    names_to = c('Outcome'),
    names_pattern = paste0('rev', "_(.*)"),
    values_to = 'rev'
  )


```

Draw the REV graph. Following this [graph code](https://fanwangecon.github.io/Stat4Econ/probability/samplespacedice.html).

```{r graph REV, fig.height = 4, fig.width = 7, fig.align = "center"}

# x-labels
x.labels <- c('λ=0.99', 'λ=0.90', 'λ=0', 'λ=-10', 'λ=-100')
x.breaks <- c(0.01, 0.10, 1, 10, 100)

# title line 2
# title_line1 <- sprintf("Percentage of Training Spots Misallocated, NSW Lalonde (AER, 1986)")
# title_line2 <- sprintf("REV (Resource Equivalent Variation) Along Planner Spectrum")

title_line1 <- sprintf("Share of resources lost (misallocation) at varying inequality averion (λ) levels")
title_line2 <- sprintf("Compare observed (random) allocations to optimal allocations (all x) vs (age only)")
title_line3 <- sprintf("Expenditure (Resource) Minimization to achieve same welfare as welfare at observed allocations")

# Relabel Variable
Outcome_levels <- c(all = "employment_prob", age = "employage_prob")
tb_rev_wage_employ_long <- tb_rev_wage_employ_long %>% 
  filter(Outcome == 'employment_prob' | Outcome == 'employage_prob') %>%
  mutate(Outcome = as_factor(Outcome)) %>%
  mutate(Outcome = fct_recode(Outcome, !!!Outcome_levels))

# Graph Results--Draw
line.plot <- tb_rev_wage_employ_long %>%
  ggplot(aes(x=one_minus_rho, y=rev,
             group=Outcome,
             colour=Outcome, size=2)) +
  geom_line(size=0.75) +
  geom_vline(xintercept=c(1), linetype="dotted") +
  labs(subtitle = paste0(title_line1, '\n', title_line2, '\n', title_line3),
       x = 'log10 Rescale of λ, Log10(λ)\nλ=1 Utilitarian, λ=-infty Rawlsian',
       y = 'Misallocation Percentage = REV (Resource Equivalent Variations)',
       caption = 'Optimally allocate 297 training spots among 722 individuals. Data from Lalonde (AER, 1986).') +
  scale_x_continuous(trans='log10', labels = x.labels, breaks = x.breaks) +
  theme_bw(base_size=8) + 
  ylim(0, 100)


# Labeling
line.plot$labels$colour <- "REV"

# Print
print(line.plot)

if (bl_save_img) {
  snm_cnts <- 'Lalonde_employ_rev.png'
  png(paste0(spt_img_save, snm_cnts),
        width = 135, height = 86, units='mm', res = 300, pointsize=7)
  print(line.plot)
  dev.off()
  png(paste0(spt_img_save_draft, snm_cnts),
        width = 135, height = 86, units='mm', res = 300,
      pointsize=5)
  print(line.plot)
  dev.off()
}
```
## Analysis of A and alpha

Generate some tables where the distributions of $A$ and $\alpha$ are compared.

### Scatter Plots

```{r, fig.height = 4, fig.width = 7, fig.align = "center"}
# Binary Marginal Effects and Prediction without Binary
ggplot.A.alpha <- function(df, svr_alpha = 'alpha_i', svr_A = "A_i",
                             slb_title = 'A_i and alpha_i (red)'){
  scatter <- ggplot(df, aes(x=!!sym(svr_A))) +
        geom_point(aes(y=!!sym(svr_alpha)), size=4, shape=4, color="red") +
        labs(title = paste0(slb_title),
             x = 'A_i = Prob Employ no Training',
             y = 'alpha_i = Effect of Training of Prob Employ',
             caption = paste0('Logit Regression on training. Control for age, educ, race. Age <= 23 or > 23 interaction.')) +
        theme_bw()
return(scatter)
}

# Plot over multiple
ggplot.A.alpha(df = dfj,
               svr_alpha = 'alpha_i_wage', svr_A = "A_i_wage",
               slb_title = 'A_i and alpha_i, wage')

ggplot.A.alpha(df = dfj,
               svr_alpha = 'alpha_i_employ', svr_A = "A_i_employ",
               slb_title = 'Employment A_i and alpha_i Joint Distribution')

```

### Histogram Plots

What is the distribution of A given alpha. This is relevant in the linear regression case
```{r, fig.height = 4, fig.width = 7, fig.align = "center"}
# Keep only relevant columns, and reshape data
dfj_hist <- dfj %>% select(id, A_i_wage, alpha_i_wage)
dfj_hist$alpha_i_wage <- factor(dfj_hist$alpha_i_wage)
dfj_hist$alpha_i_wage <- factor(dfj_hist$alpha_i_wage, labels = c('Age <= 23\nalpha_i=$454', 'Age > 23\nalpha_i=$1071'))


title_line1 <- sprintf("Wage A_i Distribution (Linear Wage), NSW Training Lalonde (AER, 1986)")
title_line2 <- sprintf("By Two Unique Levels of alpha_i: for Age <= 23 and for Age > 23")

# Graph
dfj_hist %>% ggplot(aes(x=A_i_wage, fill=alpha_i_wage)) +
      geom_density( color="#e9ecef", alpha=0.6, position = 'identity') +
      scale_fill_manual(values=c("#69b3a2", "#404080")) +
      labs(fill="") %>%
      labs(title = paste0(title_line1, '\n', title_line2),
             x = 'A_i = Expected Wage no Training (in thousands, 1979)',
             y = 'density',
             caption = paste0('Linear Wage Regression on training. Control for age, educ, race. Age <= 23 or > 23 interaction.'))
```


## Min and Max Rank Change Across rho

The max calculated by ffp_opt_anlyz_rhgin_bin is the top rank, small in number. The min calculated by the function is the lowest ranked, largest number.

### Histogram Plots and Table highest Rank Reached

Looked highest rank reached for each (highest rank (smallest number ever reached)).

```{r}
# Generate min and max gaps
dfj_highest <- dfj %>% select(id, rank_max_wage, rank_max_employ)

# Wide to long
st_gap_prefix <- 'rank_max'
dfj_highest_long <- dfj_highest %>%
  pivot_longer(
    cols = starts_with(st_gap_prefix),
    names_to = c('employvswwage'),
    names_pattern = paste0(st_gap_prefix, "_(.*)"),
    values_to = 'highestrank'
  )

# Rank change to categories
dfj_highest_long <- dfj_highest_long %>%
           mutate(highestrank_grp =
                    case_when(highestrank == 1 ~ "Top A 1",
                              highestrank <= 10  & highestrank > 1 ~ "Top B 10",
                              highestrank <= 50 & highestrank > 10 ~ "Top C 11 to 50",
                              highestrank <= 100 & highestrank > 50 ~ "Top D 51 to 100",
                              highestrank <= 297 & highestrank > 100 ~ "Top E 101 to 297",
                              highestrank > 297 ~ "Top F > 297"))

# Graph
dfj_highest_long %>% ggplot(aes(x=highestrank, fill=employvswwage)) +
      geom_histogram(color="#e9ecef", alpha=0.6, position = 'identity') +
      scale_fill_manual(values=c("#69b3a2", "#404080")) +
      labs(fill="")

# Table
dfj_highest_long %>% group_by(employvswwage, highestrank_grp) %>%
                summarize(count = n())
```

### Histogram Plots and Table Min and Max Change

From the wage and employment analysis, each generates min and max rank

1. generate rank min max gap for wage and employment: min minus max because min number is actually the larger number (lower rank)
2. reshape wide to long, gap one variable, wage vs employment categorical
3. show table summary statistics differences
4. show graph differences

```{r}
# Generate min and max gaps
dfj_gap <- dfj %>% mutate(rank_gap_wage = rank_min_wage - rank_max_wage,
                          rank_gap_employ = rank_min_employ - rank_max_employ) %>%
                select(id, rank_gap_wage, rank_gap_employ)

# Wide to long
st_gap_prefix <- 'rank_gap'
dfj_gap_long <- dfj_gap %>%
  pivot_longer(
    cols = starts_with(st_gap_prefix),
    names_to = c('employvswwage'),
    names_pattern = paste0(st_gap_prefix, "_(.*)"),
    values_to = 'rank_gap'
  )

# Rank change to categories
dfj_gap_long <- dfj_gap_long %>%
           mutate(rank_gap_grp =
                    case_when(rank_gap == 0 ~ "change A no change",
                              rank_gap <= 50  & rank_gap > 0 ~ "change B 50 positions",
                              rank_gap <= 100 & rank_gap > 50 ~ "change C 51 to 100",
                              rank_gap <= 200 & rank_gap > 100 ~ "change D 101 to 200",
                              rank_gap <= 400 & rank_gap > 200 ~ "change E 201 to 400",
                              rank_gap > 400 ~ "change F more than 401"))

# Graph
dfj_gap_long %>% ggplot(aes(x=rank_gap, fill=employvswwage)) +
      geom_histogram(color="#e9ecef", alpha=0.6, position = 'identity') +
      scale_fill_manual(values=c("#69b3a2", "#404080")) +
      labs(fill="")

# Table
dfj_gap_long %>% group_by(employvswwage, rank_gap_grp) %>%
                summarize(count = n())
```


## Table of Top 10 Individuals

```{r top 10 ranked at least once}
# 
# # Calculat the maximum rank reached by each from all the rhos we have
# # The difference between this and the other max, this computes across all rhos, employment and wage
# 
# dfj_top10 <- dfj %>%
#     select(contains("rho_")) %>%
#     reduce(pmin) %>%
#     mutate(dfj, max_rank_rhos = .)
# 
# dfj_top10 <- dfj_top10 %>% filter(max_rank_rhos <= 10) %>%
#   select(id, age, educ, black, race,
#          rho_c1_rk_employ, rho_c16_rk_employ, rho_c30_rk_employ,
#          rho_c1_rk_wage, rho_c16_rk_wage, rho_c30_rk_wage) %>%
#   rename(emp_util = rho_c1_rk_employ,
#          emp_CD   = rho_c16_rk_employ,
#          emp_rawl = rho_c30_rk_employ,
#          wag_util = rho_c1_rk_wage,
#          wag_CD   = rho_c16_rk_wage,
#          wag_rawl = rho_c30_rk_wage,
#          ) %>%
#   arrange(age, educ, race)
# 
# dim(dfj_top10)
# 
# # Graphing Library
# library(kableExtra)
# # Load Data
# dt <- mtcars[1:5, 1:6]
# # Generate latex string variable
# st_out_tex <- kable(dfj_top10, "latex")
# print(st_out_tex)
# # File out
# # fileConn <- file("./../../_file/tex/tex_sample_a_tab.tex")
# fileConn <- file("C:/users/fan/HgtOptiAlloDraft/_tab/Lalonde_wage_employ_top10.tex")
# writeLines(st_out_tex, fileConn)
# close(fileConn)
# 
# # Display results here
# dfj_top10 %>%
#     kable() %>%
#     kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```
